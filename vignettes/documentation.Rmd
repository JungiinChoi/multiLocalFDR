---
title: "Getting started with multiLocalFDR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{documentation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(multiLocalFDR)
```

# Main Functions

## SPMix()

```{r eval=FALSE}
SPMix <- function(z, tol = 5e-6, p_value = FALSE, alternative = "greater", min_iter = 3, 
                  max_iter = 30, thre_z = 1-1e-5, Uthre_gam = 0.99, Lthre_gam = 0.01 )
```

* z: Matrix which each row indicates each data point. 
* tol: Stopping criteria for the EM-type algorithm.
* p-value: If TRUE, input data indicates p-values, if FALSE, it indicates z-values or raw data.
* alternative: A character string specifying the alternative hypothesis, must be one of "greater" (default) or "less".
* min_iter, max_iter: Minimum.maximum number of iterations in the EM algorithm. 
* thre_z: The upper threshold of gamma whose z-values are used in log-concave estimates in the M-step of the EM-type algorithm.
* Uthre_gam, Lthre_gam: The upper/lower threshold of gamma which are used to compute stopping criteria for the EM algorithm.

## plotSPMix()

```{r eval=FALSE}
plotSPMix <- function(x, thre_localFDR = 0.2, testing = TRUE,
                      xlab = "x", ylab = "y", zlab = "z", coord_legend = c(8, -5, 0.2))
```

* x: object of class "SPMix".
* thre_localFDR: Threshold of localFDR determining significant data points.
* testing: If TRUE, it's for hypothesis testing. If FALSE, it's for density estimation.
* xlab, ylab, zlab: Label for x-, y-, and z-axis on histogram or 3D scatter plot.
* coord_legend: Coordinate of a legend for a 3d scatter plot when given data is 2D or 3D.
* testing: If TRUE, the visualization is for hypothesis testing, otherwise, density estimation.

# Simulations

In this section, we will use __SPMix()__ to estimate mixture density and compute local-FDR for generated data. Also, __plotSPMix()__ can visualize the fitted results
for both univariate and 2-dimensional data. 

## required libraries

```{r}
library(copula)
library(mclust)
library(mvtnorm)
library(ggplot2)
library(scatterplot3d)
```

## Univaraite

### Normal + Normal

Let's consider randomly generated 1000 data from the density below. 

$$f = 0.8 \cdot N(0,1) + 0.2 \cdot N(3.5, 0.5^2)$$

```{r}
set.seed(100)

n <- 10000
p0 <- 0.8
n0 <- rbinom(1, n, p0)
n1 <- n - n0
z0 <- rnorm(n0)
z1 <- rnorm(n1, mean = 3, sd = 0.5)
z_NN1d <- c(z0, z1)

NN1d <- SPMix(z_NN1d, min_iter = 10)
str(NN1d)
```

__SPMix()__ returns null probability($p0$), null parameters($\mu_0, \sig_0$), 
estimated density and nonnull density($f, f_1$) and estimated local-FDR value.

```{r}
# Hypothesis testing 
plotSPMix(NN1d)
```

__plotSPMix()__ can be used for both hypothesis testing and density estimation. 
If testing is TRUE (default), it gives density estimation for both normal and nonparametric parts. Also, threshold of given data by given local-FDR threshold 
is marked with dashed line. 

```{r}
# Density Estimation
plotSPMix(NN1d, testing = FALSE)
```

If testing is FALSE, it gives density estimation and classifies two parts(normal/nonparametric) by local-FDR value (local-FDR $> 0.5$?). 

### Normal + Gamma

What if alternative distribution is not normal?

$$f = 0.8 \cdot N(0,1) + 0.2 \cdot Gamma(shape = 12, rate = 4)$$

```{r}
z1_gamma <- rgamma(n1, shape = 12, rate = 4)
z_NG1d <- c(z0, z1_gamma)

NG1d <- SPMix(z_NG1d, min_iter = 10)
```

```{r}
# Hypothesis testing 
plotSPMix(NG1d)

# Density Estimation
plotSPMix(NG1d, testing = FALSE)
```

## 2-dimensional data

### Normal + Gaussian Copula

```{r}
n=3000
n0 <- rbinom(1, n, p0)
n1 <- n - n0
sig0 <- matrix(c(1, 0.25, 0.25, 1), ncol = 2, byrow = T)
V <- rCopula(n1, ellipCopula(family = "normal", param = 0.5, dim = 2))
z0 <- rmvnorm(n0, sigma = sig0)
z1 <- qnorm(V, mean = 3.5, sd = .5)
z_NN2d <- data.frame(rbind(z0, z1))

ggplot(z_NN2d, aes(x = z_NN2d[,1], y = z_NN2d[,2])) +
  geom_point(aes(color = factor(c(rep(1,n0), rep(2,n1)), labels = c("Normal(Null)", "Gaussian Copula(Alternative)")))) +
  scale_color_manual(values = c("#999999", "#E69F00"), name="")  +
  labs(title = "Random Generated Mixture density data", x="x", y = "y") +
  theme_classic()
```


```{r}
NN2d <- SPMix(z_NN2d)

plotSPMix(NN2d)
```

__plotSPMix()__ also provides visualization of 2-dimensional data.
You can set name for x-axis and y-axis using __xlab__, __ylab__. 

### Normal + Frank Copula

Let's consider nonnull distribution as Frank copula with marginal gamma distribution.

```{r}
z1_gamma <- qgamma(V, shape = 12, rate = 4)
z_NG <- data.frame(rbind(z0, z1_gamma))

ggplot(z_NG, aes(x = z_NG[,1], y = z_NG[,2])) +
  geom_point(aes(color = factor(c(rep(1,n0), rep(2,n1)), labels = c("Normal", "Gamma")))) +
  scale_color_manual(values = c("#999999", "#E69F00"), name="")  +
  labs(title = "Random Generated Normal/Gamma Mixture", x="x", y = "y") +
  theme_classic()
```

```{r}
NG2d <- SPMix(z_NG2d)

plotSPMix(NG2d)
```

## 3-dimensional data

### Normal + Gaussian Copula

Let's consider null distribution and multivariate normal density and nonnull distribution as Gaussian copula with marginal normal distribution.

```{r}
library(scatterplot3d)

Sigma0 <- matrix(c(1, 0.25, 0.25, 0.25, 1, 0.25, 0.25,0.25,1), ncol = 3)
n0 <- rbinom(1, n, p0)
n1 <- n - n0
V <- rCopula(n1, ellipCopula(family = "normal", param = 0.5, dim = 3))
z0_NN3d <- rmvnorm(n0, sigma = Sigma0)
z1_NN3d <- qnorm(V, mean = 3.5, sd = .5)
z_NN3d <- rbind(z0_NN3d, z1_NN3d)

NN3d <- SPMix(z_NN3d)
```

```{r}
plotSPMix(NN3d, thre_localFDR = 0.1)
```

Orange dots are given data with lower local-FDR (localFDR $< 0.1$).

### Normal + Frank Copula

```{r}
V_NG <- rCopula(n1, frankCopula(param = 0.5, dim = 3))
z0_NG3d <- rmvnorm(n0, sigma = Sigma0)
z1_NG3d <- qgamma(V_NG, shape = 12, rate = 4)
z_NG3d <- rbind(z0_NG3d, z1_NG3d)

NG3d <- SPMix(z_NG3d)
```

```{r}
plotSPMix(NG3d, thre_localFDR = 0.1)
```

# Applications

## Galaxy Velocity (Univariate)

Internal data 'galaxy' is a data frame including radial velocities of globular clusters of
M104 and Milky Way stars. It's known that Milky Way stars have much lower radial velocities.

```{r}
data("galaxy", package = "multiLocalFDR")
head(galaxy)
```

```{r}
z_galaxy <- galaxy$velocity
x_galaxy <- SPMix(z_galaxy, alternative = "less")
```

* z_galaxy: input data does not have to be z-values or p-values.
* alternative = "less": we know that velocities of M104 are much faster and 
follow Normal density. 

```{r}
plotSPMix(x_galaxy, testing = FALSE, xlab = "velocity(km/s)")
```

## Pathways (Multivariate)

Internal data 'pathways' is a list of significantly upregulated genes in three published studies: (1) peripheral leukocytes(L), (2) orbital inflammatory disease(O), and (3) sinus brushings(S) compared to healthy controls.

```{r}
data("pathways", package = "multiLocalFDR")
head(pathways)
```

### Univariate analysis

```{r}
## SPMix for each pathway
x_L <- SPMix(pathways[,2], p_value = TRUE)
x_O <- SPMix(pathways[,3], p_value = TRUE)
x_S <- SPMix(pathways[,4], p_value = TRUE)

## Plot results for each pathway
plotSPMix(x_L, xlab = "Peripheral Leukocytes")
plotSPMix(x_O, xlab = "Orbital Tissue")
plotSPMix(x_S, xlab = "Sinus Brushings")
```

### Multivariate Analysis

```{r}
## SpMix for 3-dimensional data
x_LOS <- SPMix(pathways[,2:4], p_value = TRUE)

## Pathways which md-fdr <= 0.01
head(pathways[params_LOS$localFDR <= 0.01,]$Gene.Set)
length(pathways[params_LOS$localFDR <= 0.01,]$Gene.Set)

# md-fdr dataframe
pathways_df <- pathways
pathways_df$localFDR <- params_LOS$localFDR
pathways_df$sgnf <- (params_LOS$localFDR <= 0.01)
head(pathways_df)
```

### 3d scatter plot 

```{r}
plotSPMix(x_LOS, thre_localFDR = 0.01, xlab = "Peripheral Leukocytes",
          ylab = "Orbital Tissue", zlab = "Sinus Brushings", coord_legend = c(6, -5, 0))
```

Orange dots are pathways with md-fdr $< 0.01$. 
